# deploy-task.yml (Modified to use host Docker socket)
platform: linux

image_resource:
  type: registry-image
  source:
    repository: docker # Use a standard image with the docker CLI installed
    tag: latest

inputs:
  - name: docker-image

params:
  CONTAINER_NAME: case-tracker-backend
  HOST_PORT: 8080
  CONTAINER_PORT: 8080

run:
  path: sh
  args:
    - -exc
    - |
      # Load the image
      docker load -i docker-image/image.tar
      IMAGE_NAME=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -n 1)
      
      # Stop and remove old container (ignore errors if doesn't exist)
      docker rm -f $CONTAINER_NAME || true
      
      # Run new container
      docker run -d \
        --name $CONTAINER_NAME \
        --restart unless-stopped \
        -p ${HOST_PORT}:${CONTAINER_PORT} \
        $IMAGE_NAME
      
      echo "âœ… Deployed on port ${HOST_PORT}"

# Add this section to mount the host's docker socket
volume_mounts:
  - path: /var/run/docker.sock
    volume:
      type: host
      path: /var/run/docker.sock
